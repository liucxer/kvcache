# KVCache多实例部署方案

## 需求分析
在3个节点上部署6个kvcache实例（每个节点2个），kvcache自动检测33000-33100范围内的可用端口，客户端可以访问这6个实例组成的集群。

## 技术方案

### 1. 端口自动检测实现

#### 1.1 修改main.go
- 添加端口检测函数，扫描33000-33100范围内的可用端口
- 为GRPC和HTTP服务分别分配可用端口
- 输出使用的端口信息到日志

#### 1.2 端口检测逻辑
1. 从33000开始扫描端口
2. 尝试绑定端口，如果成功则使用
3. 如果失败则尝试下一个端口
4. 为GRPC和HTTP服务分配连续的端口对（例如33000用于GRPC，33001用于HTTP）

### 2. 部署方案

#### 2.1 节点配置

| 节点 | 实例1 | 实例2 |
|------|-------|-------|
| 节点1 | 自动分配端口 | 自动分配端口 |
| 节点2 | 自动分配端口 | 自动分配端口 |
| 节点3 | 自动分配端口 | 自动分配端口 |

#### 2.2 数据目录结构

```
/kvcache/
├── instance1/
│   ├── data/
│   └── value_data/
├── instance2/
│   ├── data/
│   └── value_data/
```

#### 2.3 启动脚本
创建启动脚本，用于启动和管理多个实例：
- `start-instances.sh`：启动所有实例
- `stop-instances.sh`：停止所有实例
- `status-instances.sh`：查看所有实例状态和使用的端口

### 3. 客户端访问方案

#### 3.1 服务发现

##### 3.1.1 静态配置
- 客户端配置文件中列出所有可能的kvcache实例地址
- 客户端启动时尝试连接所有实例，记录可用实例

##### 3.1.2 动态发现
- 实现简单的服务注册机制，kvcache启动时将自己的地址注册到中央注册中心
- 客户端从注册中心获取可用实例列表

#### 3.2 客户端负载均衡

##### 3.2.1 GRPC客户端
- 实现基于gRPC的负载均衡
- 使用轮询或一致性哈希算法分发请求
- 支持健康检查和故障转移

##### 3.2.2 HTTP客户端
- 实现基于HTTP的负载均衡
- 支持健康检查和故障转移

#### 3.3 客户端SDK

创建客户端SDK，封装以下功能：
- 连接管理：维护与多个kvcache实例的连接
- 负载均衡：智能分发请求到不同实例
- 故障转移：当实例不可用时自动切换到其他实例
- 健康检查：定期检查实例状态
- 统一接口：提供与单个实例相同的API接口

### 4. 监控和管理

#### 4.1 监控指标
- 每个实例暴露独立的`/metrics`端点
- 使用Prometheus收集所有实例的监控数据
- 使用Grafana可视化监控指标

#### 4.2 日志管理
- 每个实例输出独立的日志文件
- 日志中包含实例使用的端口信息
- 使用ELK或Loki集中管理日志

### 5. 实现步骤

1. **修改端口检测功能**
   - 在main.go中添加端口检测函数
   - 实现33000-33100范围的端口扫描
   - 为GRPC和HTTP服务分配可用端口

2. **创建部署脚本**
   - 编写启动、停止和状态检查脚本
   - 脚本中处理多个实例的启动和管理

3. **实现客户端SDK**
   - 开发客户端负载均衡功能
   - 实现服务发现机制

4. **测试部署**
   - 在测试环境部署6个实例
   - 验证端口自动分配功能
   - 测试客户端访问和负载均衡

5. **监控配置**
   - 配置Prometheus和Grafana
   - 验证监控指标

## 预期效果

- 每个节点成功运行2个kvcache实例
- 每个实例自动检测并使用33000-33100范围内的可用端口
- 客户端可以透明访问6个实例组成的集群
- 支持自动故障转移和负载均衡
- 提供统一的监控和管理界面

## 优势

- **高可用性**：多实例部署，单点故障不影响整个系统
- **水平扩展**：可以根据需要增加更多实例
- **负载均衡**：客户端请求均匀分布到各个实例
- **自动端口分配**：无需手动配置端口，减少冲突
- **统一管理**：通过脚本和监控系统统一管理所有实例