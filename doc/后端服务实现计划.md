# 后端服务需求文档（最终完整版）

## 1. 项目概述
实现一个基于 Golang 的高性能键值存储后端服务，使用 RocksDB 作为存储引擎，同时提供 gRPC（业务使用）和 HTTP（调试使用）接口。

## 2. 功能需求

### 2.1 核心功能
| 功能 | 描述 | 接口类型 |
|------|------|----------|
| Set | 设置键值对 (key = value) | gRPC/HTTP |
| Get | 根据键获取值 | gRPC/HTTP |
| Delete | 根据键删除数据 | gRPC/HTTP |
| Scan (Key Prefix) | 根据键前缀扫描，返回匹配的键列表 | gRPC/HTTP |
| Scan (Key Prefix with Value) | 根据键前缀扫描，返回匹配的键值对 | gRPC/HTTP |
| MSet | 批量设置键值对 | gRPC/HTTP |
| MGet | 批量获取值 | gRPC/HTTP |
| MDelete | 批量删除键值对 | gRPC/HTTP |
| GetConfig | 获取当前配置 | gRPC/HTTP |
| UpdateConfig | 更新当前配置 | gRPC/HTTP |

### 2.2 技术需求
1. **存储引擎**：使用 RocksDB 作为底层存储引擎
2. **接口类型**：同时提供 gRPC 和 HTTP 接口
3. **编程语言**：使用 Golang 实现
4. **性能要求**：高性能、低延迟
5. **可靠性**：数据持久化存储
6. **可配置性**：淘汰机制可通过配置开关启用/禁用
7. **配置存储**：将当前配置项目存储到 RocksDB 中，键为 `global.config`
8. **监控系统**：提供健康检查、性能指标、存储监控和淘汰统计

## 3. 技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Golang | 1.20+ | 主要开发语言 |
| RocksDB | 7.0+ | 底层存储引擎 |
| gRPC | 1.50+ | 高性能 RPC 接口 |
| Protocol Buffers | 3.0+ | 数据序列化 |
| Gin | 1.9+ | HTTP 接口框架 |
| Prometheus | 2.0+ | 监控系统集成 |

## 4. 数据类型定义

| 层级 | Key 类型 | Value 类型 | 说明 |
|------|----------|------------|------|
| 存储层 | []byte | []byte | 高效存储，直接使用 RocksDB 原生类型 |
| gRPC 接口 | bytes | bytes | 业务接口，支持二进制数据 |
| HTTP 接口 | string | string | 调试接口，方便人工操作 |

## 5. Value 存储策略

### 5.1 存储位置选择
- 当 `value.size > value.disk_threshold` 时：
  - 将 value 存储到磁盘文件
  - RocksDB 中存储带特殊前缀的文件路径
- 当 `value.size <= value.disk_threshold` 时：
  - 将 value 直接存储到 RocksDB 中

### 5.2 特殊前缀设计
使用 `__rocksdb_disk_store__://` 作为磁盘存储路径的前缀，避免与业务数据冲突。

## 6. 内部淘汰机制

### 6.1 功能描述
实现基于创建时间（FIFO）的内部淘汰机制：
- **实现方式**：内部后台线程
- **淘汰范围**：仅淘汰存储在磁盘上的大 value
- **保留策略**：不删除 RocksDB 中的 key，只删除磁盘文件
- **触发条件**：当磁盘使用率达到 `eviction.disk_usage_threshold` 时启动
- **淘汰顺序**：按照创建时间的先后顺序，先创建的先淘汰
- **时间单位**：创建时间使用秒（s）作为单位
- **时间精度**：同一秒内写入的所有 key 使用相同的创建时间
- **配置开关**：通过 `eviction.enabled` 配置项控制是否启用淘汰机制

### 6.2 淘汰流程
1. **启动检查**：服务启动时检查 `eviction.enabled` 配置
2. **线程管理**：如果启用，则启动淘汰后台线程
3. **定期检查**：后台线程定期检查磁盘使用率
4. **触发淘汰**：当使用率超过阈值时启动淘汰
5. **选择候选**：扫描 create_time 列族，按创建时间排序，选择最早创建的大 value
6. **执行淘汰**：删除对应的磁盘文件，保留 RocksDB 中的 key
7. **标记状态**：更新 RocksDB 中的值为特殊标记
8. **清理记录**：从 create_time 列族中删除对应的条目

## 7. RocksDB 存储设计

### 7.1 列族设计

| 列族名称 | 用途 | 数据格式 |
|----------|------|----------|
| `default` | 存储主要的键值对 | `key → value` 或 `key → "__rocksdb_disk_store__://file_path"` |
| `create_time` | 存储键的创建时间 | `{timestamp} → {key_list}` |
| `metadata` | 存储服务元数据 | `{metadata_key} → {metadata_value}` |

### 7.2 键值格式

#### 7.2.1 主数据存储（default 列族）
- **小 value**（≤ threshold）：
  - 键：原始 key（[]byte）
  - 值：原始 value（[]byte）
- **大 value**（> threshold）：
  - 键：原始 key（[]byte）
  - 值：`__rocksdb_disk_store__://{file_path}`（[]byte）
- **已淘汰 value**：
  - 键：原始 key（[]byte）
  - 值：`__evicted__`（[]byte）
- **配置存储**：
  - 键：`global.config`（[]byte）
  - 值：JSON 格式的配置项目（[]byte）

#### 7.2.2 创建时间存储（create_time 列族）
- **键**：`{timestamp}`（[]byte），其中 timestamp 是 Unix 时间戳（秒）
- **值**：JSON 格式的 key 列表（[]byte），如 `["key1", "key2"]`
- **特性**：同一秒内的所有 key 存储在同一个条目中

## 8. 监控系统

### 8.1 健康检查

#### 8.1.1 HTTP 健康检查
- **接口路径**: `/api/v1/health`
- **方法**: GET
- **响应格式**:
  ```json
  {
    "status": "healthy",
    "timestamp": 1644444444,
    "components": {
      "rocksdb": "ok",
      "disk": "ok",
      "eviction": "running"
    }
  }
  ```

#### 8.1.2 gRPC 健康检查
- **服务**: 实现 gRPC Health Checking Protocol
- **接口**: `Health.Check(HealthCheckRequest) returns (HealthCheckResponse)`

### 8.2 性能指标监控

#### 8.2.1 指标收集
- **使用 Prometheus 客户端库** (`github.com/prometheus/client_golang/prometheus`)
- **核心指标**:
  - `cachefs_requests_total` (计数器): 总请求数，按操作类型分类
  - `cachefs_request_duration_seconds` (直方图): 请求处理时间，按操作类型分类
  - `cachefs_bytes_total` (计数器): 读写字节数，按操作类型分类

#### 8.2.2 指标暴露
- **HTTP 端点**: `/metrics`
- **格式**: Prometheus 文本格式

### 8.3 存储监控

#### 8.3.1 磁盘空间监控
- **指标**:
  - `cachefs_disk_usage_bytes` (gauge): 当前磁盘使用量
  - `cachefs_disk_total_bytes` (gauge): 磁盘总容量
  - `cachefs_disk_usage_percent` (gauge): 磁盘使用率百分比

#### 8.3.2 RocksDB 监控
- **指标**:
  - `cachefs_rocksdb_keys_total` (gauge): RocksDB 中的键数量
  - `cachefs_rocksdb_size_bytes` (gauge): RocksDB 存储大小
  - `cachefs_disk_files_total` (gauge): 磁盘上的文件数量

### 8.4 淘汰统计

#### 8.4.1 淘汰指标
- **指标**:
  - `cachefs_evictions_total` (计数器): 淘汰总次数
  - `cachefs_evicted_bytes_total` (计数器): 淘汰的字节总量
  - `cachefs_eviction_runs_total` (计数器): 淘汰运行次数
  - `cachefs_eviction_duration_seconds` (直方图): 淘汰操作持续时间

#### 8.4.2 淘汰触发监控
- **指标**:
  - `cachefs_eviction_triggered` (计数器): 淘汰触发次数
  - `cachefs_disk_usage_threshold` (gauge): 当前设置的磁盘使用阈值

## 9. gRPC 接口定义

### 9.1 服务定义
```protobuf
service KeyValueService {
  // 单键操作
  rpc Set(SetRequest) returns (SetResponse);
  rpc Get(GetRequest) returns (GetResponse);
  rpc Delete(DeleteRequest) returns (DeleteResponse);
  rpc ScanKeys(ScanRequest) returns (ScanKeysResponse);
  rpc ScanKeyValues(ScanRequest) returns (ScanKeyValuesResponse);
  
  // 批量操作
  rpc MSet(MSetRequest) returns (MSetResponse);
  rpc MGet(MGetRequest) returns (MGetResponse);
  rpc MDelete(MDeleteRequest) returns (MDeleteResponse);
  
  // 配置操作
  rpc GetConfig(GetConfigRequest) returns (GetConfigResponse);
  rpc UpdateConfig(UpdateConfigRequest) returns (UpdateConfigResponse);
}

// 健康检查服务
service Health {
  rpc Check(HealthCheckRequest) returns (HealthCheckResponse);
}
```

### 9.2 消息定义
```protobuf
// 单键操作消息
message SetRequest {
  bytes key = 1;
  bytes value = 2;
}

message SetResponse {
  bool success = 1;
  string error = 2;
}

message GetRequest {
  bytes key = 1;
}

message GetResponse {
  bytes value = 1;
  bool found = 2;
  string error = 3;
}

message DeleteRequest {
  bytes key = 1;
}

message DeleteResponse {
  bool success = 1;
  string error = 2;
}

message ScanRequest {
  bytes prefix = 1;
}

message ScanKeysResponse {
  repeated bytes keys = 1;
  string error = 2;
}

message ScanKeyValuesResponse {
  map<string, bytes> key_values = 1;
  string error = 2;
}

// 批量操作消息
message MSetRequest {
  map<string, bytes> key_values = 1;
}

message MSetResponse {
  bool success = 1;
  string error = 2;
}

message MGetRequest {
  repeated bytes keys = 1;
}

message MGetResponse {
  map<string, bytes> key_values = 1;
  string error = 2;
}

message MDeleteRequest {
  repeated bytes keys = 1;
}

message MDeleteResponse {
  bool success = 1;
  string error = 2;
}

// 配置操作消息
message GetConfigRequest {
  // 空消息
}

message GetConfigResponse {
  string config = 1; // JSON 格式的配置
  string error = 2;
}

message UpdateConfigRequest {
  string config = 1; // JSON 格式的配置
}

message UpdateConfigResponse {
  bool success = 1;
  string error = 2;
}

// 健康检查消息
message HealthCheckRequest {
  string service = 1;
}

message HealthCheckResponse {
  enum ServingStatus {
    UNKNOWN = 0;
    SERVING = 1;
    NOT_SERVING = 2;
    SERVICE_UNKNOWN = 3;
  }
  ServingStatus status = 1;
}
```

## 10. HTTP 接口定义

### 10.1 接口列表

| API路径 | 方法 | 功能 | 请求参数 | 成功响应 (200 OK) |
|---------|------|------|----------|------------------|
| `/api/v1/set` | POST | 设置键值对 | JSON: `{"key": "string", "value": "string"}` | `{"success": true, "error": ""}` |
| `/api/v1/get` | GET | 获取值 | 查询参数: `?key=string` | `{"value": "string", "found": true, "error": ""}` |
| `/api/v1/delete` | DELETE | 删除键值对 | 查询参数: `?key=string` | `{"success": true, "error": ""}` |
| `/api/v1/scan/keys` | GET | 扫描键前缀 | 查询参数: `?prefix=string` | `{"keys": ["string", ...], "error": ""}` |
| `/api/v1/scan/keyvalues` | GET | 扫描键值对 | 查询参数: `?prefix=string` | `{"key_values": {"string": "string", ...}, "error": ""}` |
| `/api/v1/mset` | POST | 批量设置键值对 | JSON: `{"key_values": {"key1": "value1", "key2": "value2"}}` | `{"success": true, "error": ""}` |
| `/api/v1/mget` | POST | 批量获取值 | JSON: `{"keys": ["key1", "key2"]}` | `{"key_values": {"key1": "value1", "key2": "value2"}, "error": ""}` |
| `/api/v1/mdelete` | POST | 批量删除键值对 | JSON: `{"keys": ["key1", "key2"]}` | `{"success": true, "error": ""}` |
| `/api/v1/config` | GET | 获取当前配置 | N/A | `{"config": {...}, "error": ""}` |
| `/api/v1/config` | PUT | 更新当前配置 | JSON: `{...}` | `{"success": true, "error": ""}` |
| `/api/v1/health` | GET | 健康检查 | N/A | `{"status": "healthy", "components": {...}}` |
| `/metrics` | GET | 性能指标 | N/A | Prometheus 文本格式 |

## 11. 存储层实现

### 11.1 核心组件
1. **RocksDB 封装**：处理基本的键值操作
2. **磁盘存储**：处理大 value 的磁盘存储
3. **淘汰管理器**：内部后台线程，管理淘汰逻辑
4. **创建时间管理**：处理键的创建时间记录
5. **配置管理**：处理配置的加载、存储和更新
6. **监控管理器**：处理健康检查和指标收集

### 11.2 关键流程

#### 11.2.1 服务启动
```go
func (s *Storage) Start() error {
    // 1. 初始化 RocksDB
    if err := s.initRocksDB(); err != nil {
        return err
    }
    
    // 2. 加载配置
    if err := s.loadConfig(); err != nil {
        return err
    }
    
    // 3. 存储配置到 RocksDB
    if err := s.storeConfig(); err != nil {
        return err
    }
    
    // 4. 初始化监控
    if err := s.initMonitoring(); err != nil {
        return err
    }
    
    // 5. 检查是否启用淘汰机制
    if s.config.Eviction.Enabled {
        if err := s.StartEvictionManager(); err != nil {
            return err
        }
    }
    
    return nil
}
```

#### 11.2.2 监控初始化
```go
func (s *Storage) initMonitoring() error {
    // 1. 注册 Prometheus 指标
    prometheus.MustRegister(
        s.metrics.RequestsTotal,
        s.metrics.RequestDuration,
        s.metrics.BytesTotal,
        s.metrics.DiskUsage,
        s.metrics.DiskTotal,
        s.metrics.EvictionsTotal,
    )
    
    // 2. 启动指标收集器
    go s.collectMetrics()
    
    return nil
}
```

## 12. 配置项

| 配置项 | 类型 | 默认值 | 说明 |
|--------|------|--------|------|
| rocksdb.path | string | "./data" | RocksDB 数据存储路径 |
| grpc.port | int | 50051 | gRPC 服务端口 |
| http.port | int | 8080 | HTTP 服务端口 |
| batch.max_size | int | 1000 | 批量操作最大数量限制 |
| value.disk_threshold | int | 1048576 (1MB) | 大 value 存储阈值，单位字节 |
| value.disk_path | string | "./value_data" | 大 value 磁盘存储路径 |
| eviction.enabled | bool | true | 是否启用淘汰机制 |
| eviction.disk_usage_threshold | float | 0.8 (80%) | 磁盘使用率阈值，超过此值启动淘汰 |
| eviction.check_interval | int | 60 | 淘汰检查间隔，单位秒 |
| eviction.batch_size | int | 100 | 每次淘汰的键数量 |
| monitoring.enabled | bool | true | 是否启用监控系统 |
| monitoring.metrics_path | string | "/metrics" | 指标暴露路径 |
| monitoring.health_path | string | "/api/v1/health" | 健康检查路径 |
| rocksdb.options | object | {} | RocksDB 配置选项 |

## 13. 架构设计

### 13.1 系统架构
```
┌───────────────┐     ┌───────────────┐     ┌───────────────┐
│   gRPC 接口   │────▶│  业务逻辑层   │────▶│  RocksDB 存储  │
│  (bytes 类型) │     │               │     └───────────────┘
└───────────────┘     │               │     ┌───────────────┐
┌───────────────┐     │               │────▶│  磁盘存储      │
│  HTTP 接口    │────▶│               │     └───────────────┘
│ (string 类型) │     └───────────────┘
└───────────────┘     ┌───────────────┐
                      │  配置管理    │
                      └───────────────┘
                      ┌───────────────┐
                      │  淘汰管理器    │
                      │  (内部线程)    │
                      │  (可配置开关)  │
                      └───────────────┘
                      ┌───────────────┐
                      │  监控管理器    │
                      │  (指标收集)    │
                      └───────────────┘
```

### 13.2 模块划分
1. **api/**: 接口层
   - **grpc/**: gRPC 接口实现
   - **http/**: HTTP 接口实现（调试用）
2. **service/**: 业务逻辑层
3. **storage/**: 存储层
   - **rocksdb.go**: RocksDB 操作封装
   - **disk_store.go**: 磁盘存储操作封装
   - **storage.go**: 统一存储接口
   - **eviction.go**: 淘汰机制实现
4. **config/**: 配置管理
5. **metrics/**: 监控系统
   - **metrics.go**: 指标定义
   - **collector.go**: 指标收集
   - **health.go**: 健康检查
6. **utils/**: 工具函数
7. **proto/**: Protobuf 定义文件
8. **main.go**: 主入口

## 14. 性能特性

### 14.1 存储性能
- **小 value**: 直接从 RocksDB 读取，延迟低
- **大 value**: 从磁盘读取，适合存储大型数据
- **批量操作**: 一次处理多个键值对，提高吞吐量

### 14.2 淘汰性能
- **配置可控**: 通过配置开关控制是否启用淘汰机制
- **异步淘汰**: 淘汰操作在后台线程执行，不阻塞主服务
- **批量扫描**: 一次扫描多个键，减少 RocksDB 操作次数
- **智能触发**: 仅在磁盘使用率达到阈值时启动淘汰

### 14.3 监控性能
- **轻量收集**: 指标收集操作轻量化，避免影响主服务性能
- **异步处理**: 复杂的指标计算（如磁盘使用）异步执行
- **采样优化**: 对于高频操作，使用采样技术减少开销

## 15. 安全性

### 15.1 数据安全
- **路径验证**: 严格验证磁盘文件路径，防止路径遍历攻击
- **权限控制**: 设置合理的文件权限
- **错误处理**: 避免泄露敏感的系统信息

### 15.2 接口安全
- **参数验证**: 验证输入参数的合法性
- **速率限制**: 防止 DoS 攻击
- **日志记录**: 记录关键操作日志

## 16. 部署与维护

### 16.1 依赖项
- Golang 1.20+
- RocksDB 7.0+
- gRPC 相关依赖
- Gin 框架
- Prometheus 客户端库

### 16.2 编译命令
```bash
CGO_CFLAGS="-I/opt/homebrew/include" \
CGO_LDFLAGS="-L/opt/homebrew/lib  -lrocksdb -lstdc++ -lm -lz -lbz2 -lsnappy -llz4 -lzstd" \
  go build .
```

**说明**：
- `CGO_CFLAGS`：指定 RocksDB 头文件路径
- `CGO_LDFLAGS`：指定 RocksDB 库文件路径和库名称
- 适用于 macOS 系统，其他系统可能需要调整路径

### 16.3 监控集成
- **Prometheus**: 配置抓取 `/metrics` 端点
- **Grafana**: 创建仪表盘展示监控数据
- **Alertmanager**: 设置基于指标的告警规则

### 16.4 最佳实践
- **配置调优**: 根据实际业务场景调整存储阈值和淘汰参数
- **磁盘管理**: 确保有足够的磁盘空间，定期清理无效文件
- **备份策略**: 定期备份 RocksDB 数据，确保数据安全
- **硬件选择**: 使用 SSD 存储提高性能
- **监控配置**: 设置合理的告警阈值，及时发现问题

## 17. 总结

本设计实现了一个高性能、灵活的键值存储后端服务，具有以下特点：

1. **双接口支持**: 同时提供 gRPC（业务使用）和 HTTP（调试使用）接口
2. **智能存储**: 根据 value 大小自动选择存储位置
3. **批量操作**: 支持高效的批量设置、获取和删除操作
4. **可配置淘汰**: 基于 FIFO 算法的智能淘汰机制，支持配置开关
5. **配置管理**: 提供接口查询和修改当前配置
6. **监控系统**: 完善的健康检查、性能指标、存储监控和淘汰统计
7. **时间精度**: 使用秒级时间戳，同一秒内的 key 共享创建时间
8. **透明访问**: 业务层不需要关心 value 的实际存储位置和淘汰状态
9. **可扩展性**: 模块化设计，易于添加新功能和存储后端

该服务可以作为缓存系统或轻量级键值存储使用，满足各种业务场景的需求。